# 技术面试必备基础知识-计算机网络

> 在线阅读：[CS-Notes-Network](https://cyc2018.github.io/CS-Notes/#/README?id=%e2%98%81%ef%b8%8f-%e7%bd%91%e7%bb%9c)

## 计算机网络
### 概述
- 网络的网络：网络把主机连接起来，而互联网是把多种不同的网络连接起来，因此互联网是网络的网络。

	| ![图1-1网络的网络](img/CyC2018-CS-Notes-Network_1-1.gif) |
	| :---: |
	| 图 1-1 网络的网络 |
	
- ISP：互联网服务提供商 (Internet Service Provider, ISP)，可以从互联网管理机构获得许多 IP 地址，同时拥有通信线路以及路由器等联网设备，个人或机构向 ISP 缴纳一定的费用就可以接入互联网。

- 目前的互联网是一种多层次 ISP 结构，ISP 根据覆盖面积的大小分为第一层 ISP、区域 ISP 和接入 ISP。互联网交换中心 IXP 允许两个 ISP 直接相连而不用经过第三个 ISP。

	| ![图1-2多层次 ISP 结构](img/CyC2018-CS-Notes-Network_1-2.png) |
	| :---: |
	| 图 1-2 多层次 ISP 结构 |

#### 主机之间的通信方式
- 浏览器-服务器 (B/S)：浏览器是服务的请求方，服务器是服务的提供方。
- 客户机-服务器 (C/S)：客户是服务的请求方，服务器是服务的提供方。
- 对等 (P2P)：不区分客户和服务器 ，即每个节点的功能都是等价的，节点既是客户机也是服务器。

	| ![图1-3主机之间的通信方式](img/CyC2018-CS-Notes-Network_1-3.png) |
	| :---: |
	| 图 1-3 主机之间的通信方式 |
	
#### 电路交换与分组交换
- 电路交换：电路交换用于 `电话通信系统`，两个用户要通信之前需要建立一条 `专用的物理链路`，并且在整个通信过程中 `始终占用` 该链路。由于通信的过程中不可能一直在使用传输线路，因此电路交换对线路的利用率很低，往往不到 10%。

- 分组交换：每个分组都有首部和尾部，包含了 `源地址` 和 `目的地址` 等控制信息，在同一个传输线路上 `同时传输多个分组` 互相不会影响，因此在同一条传输线路上允许同时传输多个分组，也就是说分组交换 `不需要占用` 传输线路。

	在一个邮局通信系统中，邮局收到一份邮件之后，先存储下来，然后把相同目的地的邮件一起转发到下一个目的地，这个过程就是存储转发过程，分组交换也使用了存储转发过程。

#### 时延
- 总时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延

	| ![图1-4总时延](img/CyC2018-CS-Notes-Network_1-4.png) |
	| :---: |
	| 图 1-4 总时延 |
	
- 排队时延：分组在路由器的输入队列和输出队列中排队等待的时间，取决于网络当前的通信量。
- 处理时延：主机或路由器收到分组时进行处理所需要的时间，例如分析首部、从分组中提取数据、进行差错检验或查找适当的路由等。
- 传输时延：主机或路由器传输数据帧所需要的时间。时延计算如 (1) 公式所示，$l$ 表示数据帧的长度，$v$ 表示传输速率。

	$$
	\mathcal{delay} = \frac{l(bit)}{v(bit/s)}
	\tag{1}
	$$
	
- 传播时延：电磁波在信道中传播所需要花费的时间，电磁波传播的速度接近光速。时延计算如 (2) 公式所示，其中 $l$ 表示信道长度，$v$ 表示电磁波在信道上的传播速度。

	$$
	\mathcal{delay} = \frac{l(m)}{v(m/s)}
	\tag{2}
	$$

#### 计算机网络体系结构
- 如图 1-5 为计算机网络体系结构 (包括 OSI 七层协议、五层协议以及 TCP/IP 四层协议)：

    | ![图1-5计算机网络体系结构](img/CyC2018-CS-Notes-Network_1-5.png) |
    | :---: |
    | 图 1-5 计算机网络体系结构 |

- OSI 七层协议：为把在一个网络结构下开发的系统与在另一个网络结构下开发的系统互联起来，以实现更高一级的应用，使异种机之间的通信成为可能。便于网络结构标准化，国际标准化组织 (ISO) 于 1984 年形成了开放系统互连参考模型 (Open Systems Interconnection Reference Model，OSI) 的正式文件。
	- `应用层`：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等协议。数据单位为报文。
	- `表示层`：数据压缩、加密以及数据描述，这使得应用程序不必关心在各台主机中数据内部格式不同的问题。
	- `会话层`：建立及管理会话。

		> 五层协议没有表示层和会话层，而是将这些功能留给应用程序开发者处理。

	- `运输层`：为进程提供通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。
	- `网络层`：为主机提供数据传输服务。而传输层协议是为主机中的进程提供数据传输服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。
	- `数据链路层`：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的主机提供数据传输服务。数据链路层把网络层传下来的分组封装成帧。
	- `物理层`：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。
- TCP/IP 四层协议：它只有四层，相当于五层协议中数据链路层和物理层合并为网络接口层。如图 1-5 (c) 所示。
- 数据在各层间的传递过程：在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。
	
	| ![图1-6数据在各层间的传递过程](img/CyC2018-CS-Notes-Network_1-6.png) |
	| :---: |
	| 图 1-6 数据在各层间的传递过程 |

### 物理层
#### 通信方式
- 根据信息在传输线上的传送方向，分为以下三种通信方式：
	- 单工通信：单向传输
	- 半双工通信：双向交替传输
	- 全双工通信：双向同时传输

#### 带通调制
- `模拟信号` 是 `连续` 的信号，`数字信号` 是 `离散` 的信号。带通调制把数字信号转换为模拟信号。

	| ![数字信号与模拟信号](img/CyC2018-CS-Notes-Network_2-1.jpg) |
	| :---: |
	| 图 2-1 数字信号与模拟信号 |

### 链路层

### 网络层
#### 概述
- 使用 IP 协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络。
- 与 IP 协议配套使用的还有三个协议：
	- 地址解析协议 (Address Resolution Protocol，ARP)
	- 网际控制报文协议 (Internet Control Message Protocol，ICMP)
	- 网际组管理协议 (Internet Group Management Protocol，IGMP)

#### IP 数据报格式
- IP 数据报的格式：

	| ![](img/CyC2018-CS-Notes-Network_4-1.jpg) |
	| :---: |
	| 图 4-1 IP 数据报的格式 |

    - 版本: 有 4 (IPv4) 和 6 (IPv6) 两个值；
    - 首部长度: 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4 字节。因为固定部分长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
    - 区分服务: 用来获得更好的服务，一般情况下不使用。
    - 总长度: 包括首部长度和数据部分长度。
    - 生存时间：TTL，它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当 TTL 为 0 时就丢弃数据报。
    - 协议：指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP、UDP 等。
    - 首部检验和：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。
    - 标识: 在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
    - 片偏移: 和标识符一起，用于发生分片的情况。片偏移的单位为 8 字节。

- IP 数据报的分片举例：

	| ![](img/CyC2018-CS-Notes-Network_4-1-1.png) |
	| :---: |
	| 图 4-1-1 数据报的分片举例 |

#### IP 地址编址方式
- IP 地址的编址方式经历了三个历史阶段：
	- 分类
	- 子网划分
	- 无分类

##### 分类
- 由两部分组成，网络号和主机号。其中不同分类具有不同的网络号长度，并且是固定的。

	> IP 地址 ::= {< 网络号 >, < 主机号 >}

	| ![](img/CyC2018-CS-Notes-Network_4-2.png) |
	| :---: |
	| 图 4-2 IP 地址的网络号字段和主机号字段 |

##### 子网划分
- 通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址。

	> IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}

- 要使用子网，必须配置 `子网掩码`。例如，一个 B 类地址的默认子网掩码为 255.255.0.0。

	> 注意：外部网络是看不到子网存在的。

注意，外部网络看不到子网的存在。

##### 无分类
- 无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化。

	> IP 地址 ::= {< 网络前缀号 >, < 主机号 >}

- CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法。

	> 例如 128.14.35.7/20 表示前 20 位为网络前缀。

- CIDR 的地址掩码可以继续称为子网掩码，子网掩码首 1 长度为网络前缀的长度。
- 一个 CIDR 地址块中有很多地址，一个 CIDR 表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为 `路由聚合`，也称为 `构成超网`。
- 在路由表中的项目由 “网络前缀” 和 “下一跳地址” 组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个。

### 传输层
- 网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。
- 传输层提供了进程间的逻辑通信，传输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个传输层实体之间有一条端到端的逻辑通信信道。

#### UDP 和 TCP 的特点
- `UDP`：用户数据报协议 (User Datagram Protocol，UDP) 
	- 是 `无连接` 的，`尽最大可能交付`；
	- 没有拥塞控制，面向报文 (对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部)；
	- 支持一对一、一对多、多对一和多对多的交互通信。
-  `TCP`：传输控制协议 (Transmission Control Protocol，TCP）
	-  是 `面向连接` 的，提供 `可靠交付`；
	-  有流量控制，拥塞控制，提供 `全双工通信`，`面向字节流` (把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块)；

		> TCP 一次传输的报文长度有限制，若太大则需分块、分次传输。但由于 TCP 连接的可靠性，接收方可按顺序接收数据块，并重新组成分块前的数据流，此过程就像直接相互传输字节流一样，即 `面向字节流`。
	
	-  每一条 TCP 连接只能是点对点的 (一对一)。

#### UDP 首部格式

| ![UDP用户数据报的首部和伪首部](img/CyC2018-CS-Notes-Network_5-1.jpg) |
| :---: |
| 图 5-1 用户数据报的首部和伪首部 |

首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。12 字节的伪首部是为了计算检验和临时添加的。

#### TCP 首部格式

| ![TCP报文段的首部格式](img/CyC2018-CS-Notes-Network_5-2.jpg) |
| :---: |
| 图 5-2 TCP 报文段的首部格式 |

- `序号`：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。

- `确认号`：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。

- `数据偏移`：数据部分距离报文段起始处的偏移量，实际指的是首部的长度。

- `确认 ACK`：当 ACK=1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。
- `同步 SYN` ：在连接建立时用来同步序号。
	- 当 SYN=1，ACK=0 时表示这是一个 `连接请求报文段`。
	- 若对方同意建立连接，则 `响应报文段` 中 SYN=1，ACK=1。

- `终止 FIN`：用来释放一个连接，当 FIN=1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。
- `窗口`：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。

#### TCP 的三次握手

| ![TCP的三次握手](img/CyC2018-CS-Notes-Network_5-3.jpg) |
| :---: |
| 图 5-3 TCP 的三次握手 |

> 假设 A 为客户端，B 为服务器端。

##### 细节描述
- 首先 B 处于 LISTEN 监听状态，等待客户的连接请求。

- A 向 B 发送连接请求报文，SYN=1，ACK=0，选择一个初始的序号 x。

- B 收到连接请求报文，如果同意建立连接，则向 A 发送连接确认报文，SYN=1，ACK=1，确认号为 x+1，同时也选择一个初始的序号 y。

- A 收到 B 的连接确认报文后，还要向 B 发出确认，确认号为 y+1，序号为 x+1。

- B 收到 A 的确认后，连接建立。

##### 注意事项
- 因 TCP提供的是 `全双工通信`，故通信双方的应用进程在 `任何时候` 都能发送数据
三次握手期间。
- 任何一次未收到对面的回复都会重发。
- SYN 洪泛攻击Ω：服务器易于受到 SYN 洪泛攻击，即同时多个客户端发起连接请求，从而需进行多个请求的TCP连接资源分配。

	> 服务端的TCP资源分配时刻 = 完成第二次握手时；而客户端的TCP资源分配时刻 = 完成第三次握手时。

##### 三次握手的原因
- 第三次握手是为了防止 `失效的连接请求` 到达服务器，让服务器 `错误打开连接`。

	> 例如，客户端发送的连接请求如果在网络中滞留，那么就会隔很长一段时间才能收到服务器端发回的连接确认。客户端等待一个超时重传时间之后，就会重新请求连接。但是这个滞留的连接请求最后还是会到达服务器，如果不进行三次握手，那么服务器就会打开两个连接。

- 如果有第三次握手，客户端会 `忽略` 服务器之后发送的对 `滞留连接请求` 的连接确认，不进行第三次握手，因此就不会再次打开连接。

#### TCP 的四次挥手

| ![TCP的四次挥手](img/CyC2018-CS-Notes-Network_5-4.jpg) |
| :-: |
| 图 5-4 TCP 的四次挥手 |

> 以下描述不讨论序号和确认号，因为序号和确认号的规则比较简单。并且不讨论 ACK，因为 ACK 在连接建立之后都为 1。

##### 细节描述
- A 发送连接释放报文，FIN=1。

- B 收到之后发出确认，此时 TCP 属于 `半关闭状态`，B 能向 A 发送数据但是 A 不能向 B 发送数据。

- 当 B 不再需要连接时，发送连接释放报文，FIN=1。

- A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（最大报文存活时间）后释放连接。

- B 收到 A 的确认后，释放连接。

##### 四次挥手的原因
- 客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。

- `TIME_WAIT`：客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需等待一个时间计时器设置的时间 2MSL。理由如下：
	- 确保最后一个确认报文能够到达。如果 B 没收到 A 发送来的确认报文，那么就会重新发送连接释放请求报文，A 等待一段时间就是为了处理这种情况的发生。
	- 等待一段时间是为了让本连接持续时间内所产生的所有报文都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文。

### 应用层
#### 域名系统 DNS
- 域名系统 (Domain Name System，DNS) 是一个分布式数据库，提供了 `主机名` 和 `IP` 地址之间相互转换的服务。这里的分布式数据库是指，每个站点只保留它自己的那部分数据。
- 域名具有层次结构，从上到下依次为：根域名、顶级域名、二级域名。

	| ![域名系统](img/CyC2018-CS-Notes-Network_6-1.jpg) |
	| :-: |
	| 图 6-1 域名系统 |

- DNS 可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 `53`。大多数情况下 DNS 使用 UDP 进行传输，这就要求域名解析器和域名服务器都必须自己处理超时和重传从而保证可靠性。在两种情况下会使用 TCP 进行传输：
	- 返回的响应超过的 512 字节 (UDP 最大只支持 512 字节的数据)。
	- 区域传送：指主域名服务器向辅助域名服务器传送变化的那部分数据。

#### 文件传送协议 FTP
- 文件传输协议 (File Transfer Protocol，FTP)，使用 TCP 进行连接，它需要 `两个连接` 来传送一个文件：
	- `控制连接`：服务器打开端口号 `21` 等待客户端的连接，客户端主动建立连接后，使用这个连接将客户端的命令传送给服务器，并传回服务器的应答。
	- `数据连接`：用来传送一个文件数据。
- 根据数据连接是否是服务器端主动建立，FTP 有主动和被动两种模式：
	- `主动模式`：服务器端主动建立数据连接，其中 `服务器端` 的端口号为 `20`，`客户端` 的端口号随机，但是必须 `大于 1024`，因为 0~1023 是熟知端口号。

		| ![主动模式](img/Kofe-CS-Notes-Network-6-2.png) |
		| :-: |
		| 图 6-2 主动模式 |
	
	- `被动模式`：客户端主动建立数据连接，其中客户端的端口号由客户端自己指定，服务器端的端口号随机。

		| ![被动模式](img/Kofe-CS-Notes-Network-6-2-1.png) |
		| :----------------------------------------------: |
		| 图 6-2-1 被动模式 |
	
- 主动模式要求客户端开放端口号给服务器端，需要去配置客户端的 `防火墙`。被动模式只需要服务器端开放端口号即可，无需客户端配置防火墙。但是被动模式会导致服务器端的安全性减弱，因为开放了过多的端口号。

#### 动态主机配置协议 DHCP
- 动态主机配置协议 (Dynamic Host Configuration Protocol，DHCP) 提供了即插即用的连网方式，用户不再需要手动配置 IP 地址等信息。
- DHCP 配置的内容不仅是 IP 地址，还包括 `子网掩码`、`网关 IP 地址`。
- DHCP 工作过程如下：

	| ![DHCP工作过程](img/CyC2018-CS-Notes-Network-6-3.jpg) |
	| :-: |
	| 图 6-3 DHCP 工作过程 |

	- 客户端发送 Discover 报文，该报文的目的地址为 255.255.255.255:67，源地址为 0.0.0.0:68，被放入 UDP 中，该报文被广播到同一个子网的所有主机上。如果客户端和 DHCP 服务器不在同一个子网，就需要使用中继代理。
	- DHCP 服务器收到 Discover 报文之后，发送 Offer 报文给客户端，该报文包含了客户端所需要的信息。因为客户端可能收到多个 DHCP 服务器提供的信息，因此客户端需要进行选择。
如果客户端选择了某个 DHCP 服务器提供的信息，那么就发送 Request 报文给该 DHCP 服务器。
	- DHCP 服务器发送 Ack 报文，表示客户端此时可以使用提供给它的信息。

#### 电子邮件协议

| ![](img/CyC2018-CS-Notes-Network-6-4.png) |
| :-: |
| 图 6-4 电子邮件中主要组成构件 |

- 一个电子邮件系统由三部分组成：`用户代理`、`邮件服务器` 以及 `邮件协议`。
- 邮件协议包含发送协议和读取协议：发送协议常用 SMTP，读取协议常用 POP3 和 IMAP。
    - `SMTP`：SMTP 只能发送 ASCII 码，而互联网邮件扩充 MIME 可以发送二进制文件。

		> MIME 并没有改动或者取代 SMTP，而是增加邮件主体的结构，定义了非 ASCII 码的编码规则。

    - `POP3`：POP3 的特点是只要用户从服务器上读取了邮件，就把该邮件删除。但最新版本的 POP3 可以不删除邮件。
    - `IMAP`：客户端和服务器上的邮件 `保持同步`，如果不手动删除邮件，那么服务器上的邮件也不会被删除。IMAP 这种做法可以让用户随时随地去访问服务器上的邮件。

#### 应用层协议常用端口

| 应用 | 应用层协议 | 端口号 | 传输层协议 | 备注 |
| :-: | :-: | :-: | :-: | :-: |
| 域名解析 | DNS | 53 | UDP/TCP | 长度超过 512 字节时使用 TCP |
| 动态主机配置协议 | DHCP | 67/68 | UDP | -- |
| 文件传送协议 | FTP | 20/21 | TCP | 数据连接 20，控制连接 21 |
| 远程终端协议 | TELNET | 23 | TCP | -- |
| 超文本传送协议 | HTTP | 80 | TCP | -- |
| 简单邮件传送协议 | SMTP | 25 | TCP | -- |
| 邮件读取协议 | POP3 | 110 | TCP | -- |
| 网际报文存取协议 | IMAP | 143 | TCP | -- |

#### Web 页面请求过程

| ![](img/CyC2018-CS-Notes-Network-7-1.png) |
| :-: |
| 图 7-1  Web 页面请求过程 |

##### DHCP 配置主机信息
- 主机生成 DHCP 请求报文，报文被放入 UDP 报文段 (目的端口 67; 源端口 68) 。
- UDP 报文段再放入 IP 数据报，其包含广播 IP 的目的地址 (255.255.255.255) 和源地址 (0.0.0.0)。
- IP 数据报被放置在 MAC 帧中，该帧具有目的地址 (FF:FF:FF:FF:FF:FF)，它将广播到与交换机连接的所有设备 (主机、DHCP 服务器)。
- 连接于交换机的 DHCP 服务器收到广播帧后，不断向上分解得到 IP 数据报、UDP 报文段、DHCP 请求报文，之后生成 DHCP ACK 报文。同样原理，该报文会依次被放入 UDP 报文段、IP 数据报、MAC 帧中。

	> DHCP ACK 报文：包含 IP 地址、DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。

- 该帧的目的地址是请求主机的 MAC 地址。因为交换机具有自学习能力，之前主机发送了广播帧之后就记录了 MAC 地址到其转发接口的交换表项，因此现在交换机就可以直接知道应该向哪个接口发送该帧。
- 主机收到该帧后，不断分解得到 DHCP 报文。之后就配置它的 IP 地址、子网掩码和 DNS 服务器 IP 地址，并在其 IP 转发表中安装默认网关。

##### ARP 解析 MAC 地址

- 主机通过浏览器生成一个 TCP 套接字，套接字向 Web 服务器发送 HTTP 请求。为了生成该套接字，主机需要知道网站的域名对应的 IP 地址。这里就需要 DNS 域名解析了。
- 主机生成一个 DNS 查询报文 (具有 53 号端口，因为 DNS 服务器的端口号是 53)。该 DNS 查询报文被放入目的地址为 DNS 服务器 IP 地址的 IP 数据报中。该 IP 数据报被放入一个以太网帧中，该帧将发送到网关路由器。
- DHCP 过程只知道网关路由器的 IP 地址，为了获取网关路由器的 MAC 地址，需要使用 ARP 协议。
	- 主机生成一个包含目的地址为网关路由器 IP 地址的 ARP 查询报文，将该 ARP 查询报文放入一个具有广播目的地址 (FF:FF:FF:FF:FF:FF) 的以太网帧中，并向交换机发送该以太网帧，交换机将该帧转发给所有的连接设备，包括网关路由器。
	- 网关路由器接收到该帧后，不断向上分解得到 ARP 报文，发现其中的 IP 地址与其接口的 IP 地址匹配，因此就发送一个 ARP 回答报文，包含了它的 MAC 地址，发回给主机。

##### DNS 解析域名
- 知道了网关路由器的 MAC 地址之后，就可以继续 DNS 的解析过程了。

- 网关路由器接收到包含 DNS 查询报文的以太网帧后，抽取出 IP 数据报，并根据转发表决定该 IP 数据报应该转发的路由器。

	因为路由器具有内部网关协议（RIP、OSPF）和外部网关协议（BGP）这两种路由选择协议，因此路由表中已经配置了网关路由器到达 DNS 服务器的路由表项。

- 到达 DNS 服务器之后，DNS 服务器抽取出 DNS 查询报文，并在 DNS 数据库中查找待解析的域名。

	找到 DNS 记录之后，发送 DNS 回答报文，将该回答报文放入 UDP 报文段中，然后放入 IP 数据报中，通过路由器反向转发回网关路由器，并经过以太网交换机到达主机。

##### HTTP 请求页面
- 有了 Web 服务器的 IP 地址之后，主机就能够生成 TCP 套接字，该套接字将用于向 Web 服务器发送 HTTP GET 报文。

- 在生成 TCP 套接字之前，必须先与 Web 服务器进行三次握手来建立连接。
	- 生成一个具有目的端口 80 的 TCP SYN 报文段，并向 Web 服务器发送该报文段。
	- Web 服务器收到该报文段之后，生成 TCP SYN ACK 报文段，发回给主机。
	- 最后， 主机发送  TCP ACK 确认报文段到 Web 服务器，表示成功建立连接。
- 连接建立之后，浏览器生成 HTTP GET 报文，并交付给 Web 服务器。
- Web 服务器从 TCP 套接字读取 HTTP GET 报文，生成一个 HTTP 响应报文，将 Web 页面内容放入报文主体中，发回给主机。
- 浏览器收到 HTTP 响应报文后，抽取出 Web 页面内容，之后进行渲染，显示 Web 页面。

## HTTP 协议
### 基本概念
#### 统一资源标识符 URI
- URI：URI 包含 URL 和 URN。
	- URL (Uniform Resource Locator，统一资源定位符);
	- URN (Uniform Resource Name，统一资源名称).

	| ![](img/CyC2018-CS-Notes-HTTP-1-1.png) |
	| :-: |
	| 图 1-1 URL 和 URN |

#### 请求报文和响应报文

| ![](img/CyC2018-CS-Notes-HTTP-2-1.png) |
| :-: |
| 图 2-1 请求报文和响应报文 |

### HTTP 方法
- 客户端发送的 `请求报文` 第一行为 `请求行`，包含了 `方法字段`。
- 常用 HTTP 方法：
	- GET：获取资源。当前网络请求中，绝大部分使用的是 GET 方法。
	- POST：传输实体主体。POST 主要用来传输数据，而 GET 主要用来获取资源。
	- HEAD：获取报文首部。
		- 和 GET 方法类似，但是不返回报文实体主体部分。
		- 主要用于确认 URL 的有效性以及资源更新的日期时间等。

### HTTP 状态码
- 服务器返回的 `响应报文` 中第一行为 `状态行`，包含了 `状态码以及原因短语`，用来告知客户端请求的结果。

	| 状态码 | 类别 | 含义 |
	| :-: | :-: | :-: |
	| 1XX | Informational (信息性状态码) | 接收的请求 `正在处理` |
	| 2XX | Success (成功状态码) | 请求正常 `处理完毕` |
	| 3XX | Redirection (重定向状态码) | 需要进行附加操作以完成请求 |
	| 4XX | Client Error (客户端错误状态码) | 服务器无法处理请求 |
	| 5XX | Server Error (服务器错误状态码) | 服务器处理请求出错 |

#### 1XX 信息

- 100 Continue ：表明到目前为止都很正常，客户端可以继续发送请求或者忽略这个响应。

#### 2XX 成功
- 200 OK
- 204 No Content：请求已经成功处理，但是返回的响应报文不包含实体的主体部分。一般在只需要从客户端往服务器发送信息，而不需要返回数据时使用。
- 206 Partial Content ：表示客户端进行了范围请求，响应报文包含由 Content-Range 指定范围的实体内容。

#### 3XX 重定向
- 301 Moved Permanently：永久性重定向。
- 302 Found：临时性重定向。
- 303 See Other：和 302 有着相同的功能，但 303 明确要求客户端应该采用 `GET` 方法获取资源。

	> 注：虽然 HTTP 协议规定 301、302 状态下重定向时不允许把 POST 方法改成 GET 方法，但是大多数浏览器都会在 301、302 和 303 状态下的重定向把 POST 方法改成 GET 方法。

- 304 Not Modified：如果请求报文首部包含一些 `指定条件`，例如：If-Match，If-Modified-Since，If-None-Match，If-Range，If-Unmodified-Since，如果不满足条件，则服务器会返回 304 状态码。
- 307 Temporary Redirect：临时重定向，与 302 的含义类似，但是 307 要求浏览器不会把重定向请求的 POST 方法改成 GET 方法。

#### 4XX 客户端错误
- 400 Bad Request：请求报文中存在语法错误。
- 401 Unauthorized：该状态码表示发送的请求需要有认证信息（BASIC 认证、DIGEST 认证）。如果之前已进行过一次请求，则表示用户认证失败。
- 403 Forbidden：请求被拒绝。
- 404 Not Found

#### 5XX 服务器错误
- 500 Internal Server Error：服务器正在执行请求时发生错误。
- 503 Service Unavailable：服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。

### HTTP 首部
- 有 4 种类型的首部字段：`通用首部字段`、`请求首部字段`、`响应首部字段` 和 `实体首部字段`。
- 各种首部字段及其含义如下 (不需要全记，仅供查阅)。

#### 通用首部字段

| 首部字段名 | 说明 |
| :--- | :--- |
| Cache-Control     | 控制缓存的行为 |
| Connection        | 控制不再转发给代理的首部字段、管理持久连接 |
| Date              | 创建报文的日期时间 |
| Pragma            | 报文指令 |
| Trailer           | 报文末端的首部一览 |
| Transfer-Encoding | 指定报文主体的传输编码方式 |
| Upgrade           | 升级为其他协议 |
| Via               | 代理服务器的相关信息 |
| Warning           | 错误通知 |

#### 请求首部字段

| 首部字段名 | 说明 |
| :--- | :--- |
| Accept              | 用户代理可处理的媒体类型 |
| Accept-Charset      | 优先的字符集 |
| Accept-Encoding     | 优先的内容编码 |
| Accept-Language     | 优先的语言（自然语言） |
| Authorization       | Web 认证信息 |
| Expect              | 期待服务器的特定行为 |
| From                | 用户的电子邮箱地址 |
| Host                | 请求资源所在服务器 |
| If-Match            | 比较实体标记（ETag） |
| If-Modified-Since   | 比较资源的更新时间 |
| If-None-Match       | 比较实体标记（与 If-Match 相反） |
| If-Range            | 资源未更新时发送实体 Byte 的范围请求 |
| If-Unmodified-Since | 比较资源的更新时间（与 If-Modified-Since 相反） |
| Max-Forwards        | 最大传输逐跳数 |
| Proxy-Authorization | 代理服务器要求客户端的认证信息 |
| Range               | 实体的字节范围请求 |
| Referer             | 对请求中 URI 的原始获取方 |
| TE                  | 传输编码的优先级 |
| User-Agent          | HTTP 客户端程序的信息 |

#### 响应首部字段

| 首部字段名 | 说明 |
| :--- | :--- |
| Accept-Ranges      | 是否接受字节范围请求 |
| Age                | 推算资源创建经过时间 |
| ETag               | 资源的匹配信息 |
| Location           | 令客户端重定向至指定 URI |
| Proxy-Authenticate | 代理服务器对客户端的认证信息 |
| Retry-After        | 对再次发起请求的时机要求 |
| Server             | HTTP 服务器的安装信息 |
| Vary               | 代理服务器缓存的管理信息 |
| WWW-Authenticate   | 服务器对客户端的认证信息 |

#### 实体首部字段

| 首部字段名 | 说明 |
| :--- | :--- |
| Allow            | 资源可支持的 HTTP 方法 |
| Content-Encoding | 实体主体适用的编码方式 |
| Content-Language | 实体主体的自然语言 |
| Content-Length   | 实体主体的大小 |
| Content-Location | 替代对应资源的 URI |
| Content-MD5      | 实体主体的报文摘要 |
| Content-Range    | 实体主体的位置范围 |
| Content-Type     | 实体主体的媒体类型 |
| Expires          | 实体主体过期的日期时间 |
| Last-Modified    | 资源的最后修改日期时间 |

### 具体应用
#### 连接管理
#### Cookies 与 Session

### HTTPS

### HTTP/2.0

### HTTP/1.1 新特性
### GET 和 POST 比较

## Socket 协议

### I/O 模型
### I/O 服用